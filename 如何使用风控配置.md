# 如何使用风控配置功能

## 🎯 功能说明

风控配置已成功注入到所有AI分析师的提示词中。AI在做交易决策时会自动遵守系统的风控规则。

## ⚙️ 配置风控参数

### 方法1: 修改 .env 文件

编辑项目根目录的 `.env` 文件（如果没有，复制 `env.example`）：

```bash
# 基础配置
INITIAL_BALANCE=1000.0          # 初始资金（美元）

# 风控配置
MAX_POSITION_SIZE=0.1           # 单笔最大仓位 (10% = 0.1)
RISK_PER_TRADE=0.02            # 单笔风险限额 (2% = 0.02)
MAX_WALLET_USAGE=0.5           # 钱包余额使用上限 (50% = 0.5)
MARGIN_RESERVE_RATIO=0.3       # 保证金预留比例 (30% = 0.3)
RISK_THRESHOLD=0.7             # 风险阈值 (0.7 = 70%)
CONFIDENCE_THRESHOLD=0.6       # 置信度阈值 (0.6 = 60%)
MAX_CONCURRENT_TRADES=3        # 最大并发交易数
```

### 方法2: 查看默认值

默认值在 `backend/config.py` 中定义，如果 `.env` 没有配置，会使用默认值。

## 📊 风控参数详解

| 参数 | 说明 | 默认值 | 建议范围 |
|------|------|--------|----------|
| **INITIAL_BALANCE** | 初始账户资金 | 100.0 | 根据实际情况 |
| **MAX_POSITION_SIZE** | 单笔交易最大占总资金比例 | 0.1 (10%) | 0.05 - 0.2 |
| **RISK_PER_TRADE** | 每笔交易允许的最大风险 | 0.02 (2%) | 0.01 - 0.05 |
| **MAX_WALLET_USAGE** | 最多使用多少钱包余额 | 0.2 (20%) | 0.3 - 0.8 |
| **MARGIN_RESERVE_RATIO** | 合约交易保证金预留 | 0.3 (30%) | 0.2 - 0.5 |
| **RISK_THRESHOLD** | 风险评分超过此值拒绝交易 | 0.7 | 0.6 - 0.8 |
| **CONFIDENCE_THRESHOLD** | AI置信度最低要求 | 0.6 | 0.5 - 0.7 |
| **MAX_CONCURRENT_TRADES** | 同时持有的最大交易数量 | 3 | 2 - 5 |

## 🔧 使用示例

### 示例1: 保守风控配置

适合新手或谨慎交易者：

```bash
MAX_POSITION_SIZE=0.05          # 单笔最多5%
RISK_PER_TRADE=0.01            # 单笔风险1%
MAX_WALLET_USAGE=0.3           # 最多用30%资金
RISK_THRESHOLD=0.6             # 风险阈值60%
CONFIDENCE_THRESHOLD=0.7       # 置信度要求70%
MAX_CONCURRENT_TRADES=2        # 最多2个持仓
```

### 示例2: 激进风控配置

适合经验丰富的交易者：

```bash
MAX_POSITION_SIZE=0.2           # 单笔最多20%
RISK_PER_TRADE=0.05            # 单笔风险5%
MAX_WALLET_USAGE=0.8           # 最多用80%资金
RISK_THRESHOLD=0.8             # 风险阈值80%
CONFIDENCE_THRESHOLD=0.5       # 置信度要求50%
MAX_CONCURRENT_TRADES=5        # 最多5个持仓
```

### 示例3: 平衡风控配置（推荐）

适合大多数用户：

```bash
MAX_POSITION_SIZE=0.1           # 单笔最多10%
RISK_PER_TRADE=0.02            # 单笔风险2%
MAX_WALLET_USAGE=0.5           # 最多用50%资金
RISK_THRESHOLD=0.7             # 风险阈值70%
CONFIDENCE_THRESHOLD=0.6       # 置信度要求60%
MAX_CONCURRENT_TRADES=3        # 最多3个持仓
```

## 🚀 应用配置

### 1. 修改配置文件

编辑 `.env` 文件，设置你想要的风控参数。

### 2. 重启后端服务

```bash
# Windows
python backend/main.py

# 或使用启动脚本
启动后端.bat
```

### 3. 验证配置

运行测试脚本验证配置是否生效：

```bash
python test_risk_control_injection.py
```

## 💡 AI如何使用这些配置

每个AI分析师在分析时都会收到风控规则：

```
===== 系统风控规则（必须遵守）=====
- 初始资金: $1000.00
- 单笔最大仓位: 10.0% (占总资金比例)
- 单笔风险限额: 2.0% (每笔交易最大风险)
- 钱包余额使用上限: 50% (防止满仓)
- 保证金预留比例: 30% (合约交易)
- 风险阈值: 0.70 (超过此值应拒绝交易)
- 置信度阈值: 0.60 (建议置信度最低标准)
- 最大并发交易数: 3个

**重要风控原则：**
1. 任何交易建议的仓位不得超过 10.0%
2. 单笔交易风险不得超过 2.0%
3. 做空交易需要更严格的风控（建议仓位再减30%）
4. 极端波动市场应降低仓位或拒绝交易
5. 置信度低于 0.60 的交易应该拒绝
=====================================
```

## 🎯 实际效果

### 技术分析师
- 会考虑仓位限制，不会建议超过 `MAX_POSITION_SIZE` 的仓位
- 在高风险市场会更加保守

### 风险管理经理
- 检查是否违反风控规则
- 如果风险评分超过 `RISK_THRESHOLD`，会拒绝交易

### 投资组合经理
- 综合考虑所有风控参数做最终决策
- 确保交易符合系统风控要求

### 做空交易特殊处理
- 自动将仓位减少30%（因为做空风险更高）
- 需要更高的置信度和更严格的止损

## ⚠️ 重要提醒

1. **配置生效时机**
   - 修改 `.env` 后必须重启后端服务
   - 配置在服务启动时加载

2. **参数合理性**
   - 确保参数值在合理范围内
   - `MAX_POSITION_SIZE` 必须小于 1.0
   - `RISK_PER_TRADE` 通常应小于 `MAX_POSITION_SIZE`

3. **AI建议 vs 实际执行**
   - AI会遵守风控规则给出建议
   - 但系统仍会在执行前再次验证
   - 双重保护确保安全

4. **动态调整**
   - 可以根据市场情况动态调整参数
   - 牛市可以适当放宽，熊市应该收紧
   - 建议定期回顾和优化配置

## 🔍 监控与优化

### 查看AI决策过程

查看日志文件，可以看到AI如何考虑风控规则：

```
logs/backend.log
```

### 分析交易结果

- 记录不同风控参数下的交易表现
- 统计违反风控的次数（应该为0）
- 分析风控对盈利的影响

### 优化建议

1. **初期**: 使用保守配置，确保系统稳定
2. **调优**: 根据实际表现逐步调整参数
3. **测试**: 在虚拟环境充分测试后再应用到真实交易
4. **记录**: 保存配置变更历史和对应的交易结果

## 📚 相关文档

- [风控配置注入完成报告.md](风控配置注入完成报告.md) - 技术实现详情
- [交易风控规则说明.md](交易风控规则说明.md) - 风控系统整体说明
- [AI团队协同止盈止损系统说明.md](AI团队协同止盈止损系统说明.md) - AI团队说明

## 🆘 常见问题

**Q: 修改配置后没有生效？**
A: 确保重启了后端服务。配置在启动时加载。

**Q: AI还是给出了超过风控限制的建议？**
A: 这种情况不应该发生。如果发生，请检查日志并报告问题。

**Q: 可以在运行时动态修改配置吗？**
A: 目前需要重启服务。未来可以考虑实现热重载功能。

**Q: 不同的AI模型会有不同的风控理解吗？**
A: 所有AI模型都会收到相同的风控规则，应该有相似的理解。但可能在具体应用时略有差异。

---

**最后更新**: 2025-10-24  
**维护者**: AI Trading System Team

