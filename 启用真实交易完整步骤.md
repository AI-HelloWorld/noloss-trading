# 启用真实交易完整步骤

## 🎉 测试结果

刚才的测试显示系统在**模拟模式**下运行正常：

```
✅ API配置正确
✅ 账户认证成功
✅ 钱包余额查询: $1,000.00 USDT（模拟）
✅ 当前持仓: 0个
✅ 市场数据正常
⚠️ 模式: 模拟模式（需要切换到真实模式）
⚠️ 钱包地址: 未配置
```

---

## 📋 启用真实交易需要的步骤

### 准备阶段（在AsterDEX网站操作）

#### 步骤1: 获取API密钥

1. 访问：https://www.asterdex.com/zh-CN/api-management
2. 点击"创建API密钥"
3. 设置权限：
   ```
   ✅ 读取账户信息
   ✅ 现货交易
   ✅ 合约交易
   ❌ 提现（不要勾选）
   ❌ 转账（不要勾选）
   ```
4. 保存API Key和Secret

#### 步骤2: 授权API钱包

⚠️ **重要：AsterDEX要求授权API钱包才能交易**

1. 访问：https://www.asterdex.com/zh-CN/api-wallet
2. 点击"授权新钱包"
3. 选择或创建一个钱包地址
4. 确认授权
5. 复制钱包地址

**示例钱包地址：**
```
0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb
```

#### 步骤3: 确认钱包有USDT

1. 查看钱包余额
2. 确保有足够USDT（建议至少$100）
3. 记录当前余额

---

### 配置阶段（在本地操作）

#### 步骤4: 填写配置文件

**打开：** `真实交易配置模板.env`

**填写以下信息：**

```env
# ====================================================
# AsterDEX API配置
# ====================================================
ASTER_DEX_API_KEY=您从AsterDEX获取的API_Key
ASTER_DEX_API_SECRET=您从AsterDEX获取的API_Secret

# ====================================================
# 钱包配置
# ====================================================
WALLET_ADDRESS=您在AsterDEX授权的钱包地址

# ====================================================
# 资金配置
# ====================================================
INITIAL_BALANCE=500.0  # 或您希望使用的金额

# ====================================================
# AI模型（必需）
# ====================================================
DEEPSEEK_API_KEY=sk-您的DeepSeek密钥

# ====================================================
# 风控配置（建议首次使用保守设置）
# ====================================================
MAX_WALLET_USAGE=0.3                # 单笔最多30%（保守）
MARGIN_RESERVE_RATIO=0.2            # 合约只用20%（保守）
MAX_POSITION_SIZE=0.05              # 最大仓位5%（保守）
RISK_THRESHOLD=0.6                  # 风险阈值降低
CONFIDENCE_THRESHOLD=0.7            # 置信度提高

# ====================================================
# 交易配置
# ====================================================
ENABLE_AUTO_TRADING=true
TRADE_CHECK_INTERVAL=300
```

#### 步骤5: 保存配置

```bash
# Windows
copy 真实交易配置模板.env .env

# Linux/Mac
cp 真实交易配置模板.env .env
```

#### 步骤6: 启用真实模式

**修改文件：** `backend/exchanges/aster_dex.py`

**找到第26行，修改为：**

```python
# 注释掉强制模拟模式
# self.use_mock_data = True  # ← 注释掉这行

# 启用真实模式自动检测
self.use_mock_data = not (self.api_key and self.api_secret)  # ← 取消注释
```

---

### 测试阶段

#### 步骤7: 重新测试连接

```bash
python test_wallet_connection.py
```

**预期输出（真实模式）：**

```
🔍 AsterDEX钱包连接测试
============================================================
📋 步骤1: 检查API配置
✅ API Key: 55f5fb7544...983fdd75a9
✅ API Secret: ********************
✅ 基础URL: https://fapi.asterdex.com
✅ 模式: 真实模式  ← 应该显示真实模式

✅ API钱包地址: 0x742d...bEb  ← 显示您的钱包地址

🔌 步骤2: 测试API连接
✅ 公开API连接成功
✅ 支持的交易对数量: 130+

🔐 步骤3: 测试账户认证
✅ 账户认证成功  ← 关键！

💰 步骤4: 查询钱包余额
✅ 钱包余额查询成功

您的钱包余额:  ← 真实余额
------------------------------------------------------------
  USDT:
    可用: 1,234.56  ← 您的真实USDT余额
    冻结: 0.00
    总计: 1,234.56
------------------------------------------------------------

💰 USDT可用余额: $1,234.56
✅ 钱包余额充足，可以开始交易

📊 步骤5: 测试获取持仓
✅ 持仓查询成功
   当前持仓数量: X个  ← 您的真实持仓

📈 步骤6: 测试市场数据
✅ 市场数据获取成功
   BTC价格: $109,234.56  ← 真实市场价格

============================================================
🎉 钱包连接测试完成
============================================================

✅ 测试结果汇总:
  ✅ API配置正确
  ✅ 账户认证成功
  ✅ 钱包余额: $1,234.56 USDT  ← 真实余额
  ✅ 当前持仓: X个
  ✅ 市场数据正常

🚀 系统已准备就绪，可以开始真实交易！
```

**如果看到以上输出，说明配置成功！**

#### 步骤8: 停止当前后端

```bash
# Windows
Stop-Process -Name python -Force

# Linux/Mac
pkill -f uvicorn
```

#### 步骤9: 重启后端（真实模式）

```bash
python -m uvicorn backend.main:app --host 0.0.0.0 --port 8001 --reload
```

**查看启动日志，应该看到：**
```
✅ AsterDEX客户端初始化成功 (真实模式)  ← 真实模式
📡 API Key: 55f5fb7544...983fdd75a9
🔗 Base URL: https://fapi.asterdex.com
💰 钱包地址: 0x742d...bEb
```

**而不是：**
```
⚠️ 未配置AsterDEX API密钥，使用模拟数据模式  ← 模拟模式
```

---

### 验证阶段

#### 步骤10: 验证真实余额检测

```bash
# 查询投资组合
curl http://localhost:8001/api/portfolio
```

**应该返回您的真实余额：**
```json
{
  "total_balance": 1234.56,  // 您的真实钱包余额
  "cash_balance": 1234.56,
  "positions_value": 0,
  "total_pnl": 234.56,       // 相对于INITIAL_BALANCE的盈亏
  "total_pnl_percentage": 23.46
}
```

#### 步骤11: 小额测试交易（可选但推荐）

**创建测试脚本 `test_real_trade.py`：**

```python
import asyncio
import sys
sys.path.append('.')

from backend.database import get_db
from backend.trading.trading_engine import trading_engine
from backend.exchanges.aster_dex import aster_client

async def test_real_trade():
    """测试真实小额交易"""
    print("🧪 开始真实交易测试（小额）...")
    
    async for db in get_db():
        # 查询当前余额
        portfolio = await trading_engine.get_portfolio_summary(db)
        print(f"\n交易前余额: ${portfolio['total_balance']:.2f}")
        
        # 获取BTC价格
        ticker = await aster_client.get_ticker("BTCUSDT")
        print(f"BTC价格: ${ticker['price']:.2f}")
        
        # 执行极小额测试（约$10）
        decision = {
            "action": "buy",
            "confidence": 0.9,
            "position_size": 0.01,  # 只用1%
            "reasoning": "🧪 真实交易测试：验证API连接和钱包余额更新"
        }
        
        market_data = {
            "price": ticker['price'],
            "change_24h": ticker.get('change_24h', 0),
            "high_24h": ticker.get('high_24h', 0),
            "low_24h": ticker.get('low_24h', 0),
            "volume_24h": ticker.get('volume_24h', 0),
        }
        
        print(f"\n准备买入约$10的BTC...")
        await trading_engine._execute_trade(db, "BTCUSDT", decision, market_data)
        
        # 查看结果
        portfolio_after = await trading_engine.get_portfolio_summary(db)
        print(f"\n交易后余额: ${portfolio_after['total_balance']:.2f}")
        print(f"持仓数量: {len(portfolio_after['positions'])}")
        
        if portfolio_after['positions']:
            for pos in portfolio_after['positions']:
                print(f"  {pos['symbol']}: {pos['amount']:.6f} @ ${pos['current_price']:.2f}")
        
        print("\n✅ 真实交易测试完成")
        print("💡 请在AsterDEX查看订单历史验证")
        
        break

asyncio.run(test_real_trade())
```

**运行测试：**
```bash
python test_real_trade.py
```

**验证：**
1. 查看脚本输出
2. 登录AsterDEX查看订单历史
3. 确认钱包余额变化
4. 检查系统持仓更新

---

## 🛡️ 安全检查清单

### 配置前必须确认

- [ ] API权限只包含交易，**不含提现**
- [ ] 钱包地址已在AsterDEX授权
- [ ] 钱包中有足够USDT
- [ ] 理解真实交易风险
- [ ] 使用可承受损失的资金
- [ ] 风控参数设置为保守模式

### 启用后必须监控

- [ ] 每天查看交易日志
- [ ] 每天检查钱包余额
- [ ] 关注异常波动
- [ ] 验证余额检测正常
- [ ] 必要时手动干预

---

## 💰 钱包余额实时检测说明

### AsterDEX专业API余额检测

**系统会调用以下API端点：**

```
GET /fapi/v2/balance
Authorization: Bearer {API_KEY}
Signature: {HMAC_SHA256}
```

**返回数据：**
```json
{
  "balances": [
    {
      "asset": "USDT",
      "free": 1234.56,      // 可用余额
      "locked": 100.00,     // 冻结余额（订单中）
      "total": 1334.56      // 总余额
    },
    {
      "asset": "BTC",
      "free": 0.025,
      "locked": 0.0,
      "total": 0.025
    }
  ]
}
```

### 余额检测时机

系统会在以下时刻自动检测钱包余额：

| 时机 | API调用 | 频率 |
|------|---------|------|
| 系统启动 | `/fapi/v2/balance` | 1次 |
| 每笔交易前 | `/fapi/v2/balance` | 每笔 |
| 每笔交易后 | `/fapi/v2/balance` | 每笔 |
| 定期同步 | `/fapi/v2/balance` | 每5分钟 |

### 日志示例

**真实模式下的余额检测日志：**
```
22:30:15 | INFO | 💰 资产余额已更新: $1,234.56
22:30:15 | INFO |    ├─ 钱包USDT: $800.00 (来自AsterDEX API)
22:30:15 | INFO |    ├─ BTC持仓: $434.56 (0.004 BTC @ $108,640)
22:30:15 | INFO |    └─ 总资产: $1,234.56
22:30:15 | DEBUG | 🔍 余额来源: AsterDEX /fapi/v2/balance
22:30:15 | DEBUG | 💳 钱包地址: 0x742d...bEb
```

---

## 📝 配置文件示例

### 完整的.env配置示例

```env
# AsterDEX API（必需）
ASTER_DEX_API_KEY=55f5fb7544a1b2c3d4e5f6789abc123def456ghi789jkl012mno
ASTER_DEX_API_SECRET=abc123def456ghi789jkl012mno345pqr678stu901vwx234yz

# 钱包地址（必需）
WALLET_ADDRESS=0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb

# 初始资金
INITIAL_BALANCE=500.0

# AI模型
DEEPSEEK_API_KEY=sk-your-deepseek-key

# 风控（保守设置）
MAX_WALLET_USAGE=0.3
MARGIN_RESERVE_RATIO=0.2
MAX_POSITION_SIZE=0.05
RISK_THRESHOLD=0.6
CONFIDENCE_THRESHOLD=0.7

# 交易开关
ENABLE_AUTO_TRADING=true
```

---

## 🎯 当前状态 vs 目标状态

### 当前（模拟模式）

```
✅ API Key: 已配置
✅ API Secret: 已配置
⚠️ 钱包地址: 未配置
⚠️ 模式: 模拟模式
💰 余额来源: 模拟$1,000
📊 交易执行: 模拟
```

### 目标（真实模式）

```
✅ API Key: 您的真实API Key
✅ API Secret: 您的真实API Secret
✅ 钱包地址: 您的授权钱包地址
✅ 模式: 真实模式
💰 余额来源: 钱包实时余额
📊 交易执行: 真实订单
```

---

## 🚀 您现在需要提供

### 必需信息（3项）

1. **AsterDEX API Key**
   ```
   从：https://www.asterdex.com/zh-CN/api-management
   ```

2. **AsterDEX API Secret**
   ```
   创建API Key时一起生成
   ```

3. **授权的钱包地址**
   ```
   从：https://www.asterdex.com/zh-CN/api-wallet
   必须先授权才能填写
   ```

### 可选信息

4. 您希望使用的初始资金（$100-$500建议）
5. 风控偏好（保守/平衡/激进）

---

## 📧 提供信息的格式

**请按以下格式提供：**

```
API Key: [您的完整API Key]
API Secret: [您的完整API Secret]
钱包地址: [您授权的钱包地址]
初始资金: $500
风控: 保守
```

**或者告诉我：**
```
我已经填写好真实交易配置模板.env文件了
```

---

## ⚠️ 重要提醒

### AsterDEX专业API特殊要求

根据AsterDEX官方文档：

1. **✅ 必须授权API钱包**
   - 在API钱包页面授权
   - 未授权的地址无法交易
   - 每个账户最多30个授权地址

2. **✅ API权限设置**
   - 读取账户信息：必需
   - 交易权限：必需
   - 提现权限：禁用

3. **✅ 签名认证**
   - 使用HMAC-SHA256签名
   - 时间戳验证
   - 系统时间要准确

---

## 🎉 测试已通过

**当前测试结果：模拟模式下所有功能正常 ✅**

**下一步：**

请提供：
1. AsterDEX API Key
2. AsterDEX API Secret  
3. 授权的钱包地址

我会立即帮您：
1. 配置真实交易模式
2. 验证钱包连接
3. 测试余额检测
4. 启用自动交易
5. 监控系统运行

**准备好后，请提供上述3项信息！** 🚀

---

**更新时间：** 2025年10月24日 00:17  
**测试状态：** ✅ 模拟模式测试通过  
**下一步：** 等待您提供真实API配置

