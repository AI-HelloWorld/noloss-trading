# 交易风控规则 - 防爆仓保护机制

## ✅ 已实现的风控规则

### 规则概览

系统现在实施严格的4层风控保护，确保：
- ✅ 不会超额使用钱包余额
- ✅ 合约交易有足够保证金
- ✅ 避免爆仓风险
- ✅ 保护本金安全

---

## 🛡️ 四层风控规则

### 规则1：钱包余额限制

**保护目标：** 防止单笔交易占用过多资金

**规则：**
```
每笔交易不超过钱包余额的50%
```

**计算公式：**
```python
cash_balance = 总资产 - 持仓价值
max_trade_by_wallet = cash_balance × 50%
```

**示例：**
```
现金余额: $600
钱包限制: $600 × 50% = $300
结果: 单笔交易最多$300
```

**配置参数：**
```env
MAX_WALLET_USAGE=0.5  # 50%，可调整为0.3-0.7
```

### 规则2：AI建议仓位

**保护目标：** 遵循AI的风险评估

**规则：**
```
使用AI建议的仓位大小，但受规则1限制
```

**计算公式：**
```python
ai_suggested_value = 总资产 × AI建议仓位
actual_value = min(钱包限制, AI建议)
```

**示例：**
```
总资产: $1,000
AI建议: 10%总资产 = $100
钱包限制: $300
结果: 使用$100（AI建议更保守）
```

### 规则3：合约保证金预留（重要！）

**保护目标：** 防止合约爆仓

**规则：**
```
合约交易（做空）只使用30%现金，留70%作为保证金
```

**计算公式：**
```python
if action == "short":
    margin_ratio = 30%
    max_trade_value = cash_balance × 30%
    reserved_margin = cash_balance × 70%  # 预留保证金
```

**示例（做空）：**
```
现金余额: $600
合约限制: $600 × 30% = $180
预留保证金: $600 × 70% = $420
结果: 做空交易最多$180，剩余$420保证金
```

**配置参数：**
```env
MARGIN_RESERVE_RATIO=0.3  # 30%使用，70%预留
```

**爆仓保护说明：**
```
假设做空BTC $180（价格$100,000）:
- 开仓金额: $180
- 预留保证金: $420
- 如果BTC涨50%到$150,000:
  - 亏损: $180 × 50% = $90
  - 剩余保证金: $420
  - 不会爆仓 ✅
```

### 规则4：最小交易金额

**保护目标：** 避免微小交易（手续费不划算）

**规则：**
```
单笔交易至少$10
```

**示例：**
```
计算结果: $5
判断: < $10
结果: 跳过交易
```

---

## 📊 风控计算流程

```
开始交易决策
    ↓
计算现金余额
    ↓
规则1: 钱包50%限制 → $300
    ↓
规则2: AI建议 → $100
    ↓
取较小值 → $100
    ↓
规则3: 如果是合约 → 再限制到30%
    ↓
规则4: 检查是否≥$10
    ↓
计算交易数量
    ↓
执行交易
```

---

## 💰 实际案例

### 案例1：现货买入（Buy）

**账户状态：**
```
总资产: $1,000
现金余额: $600
持仓价值: $400
```

**AI决策：**
```
action: buy
position_size: 0.1 (10%总资产)
```

**风控计算：**
```
1. 钱包50%限制: $600 × 50% = $300
2. AI建议: $1,000 × 10% = $100
3. 取较小值: min($300, $100) = $100
4. 不是合约，无需额外限制
5. 检查: $100 ≥ $10 ✅
```

**结果：**
```
✅ 使用$100买入
✅ 剩余现金$500
✅ 资金使用率: 16.7%
```

### 案例2：合约做空（Short）

**账户状态：**
```
总资产: $1,000
现金余额: $800
持仓价值: $200
```

**AI决策：**
```
action: short
position_size: 0.2 (20%总资产)
```

**风控计算：**
```
1. 钱包50%限制: $800 × 50% = $400
2. AI建议: $1,000 × 20% = $200
3. 取较小值: min($400, $200) = $200
4. 合约保证金限制: $800 × 30% = $240
5. 再取较小值: min($200, $240) = $200
6. 检查: $200 ≥ $10 ✅
```

**结果：**
```
✅ 做空价值$200
✅ 预留保证金: $800 × 70% = $560
✅ 爆仓保护: 价格涨280%才会爆仓
✅ 安全性: 极高
```

### 案例3：余额不足

**账户状态：**
```
总资产: $1,000
现金余额: $50
持仓价值: $950
```

**AI决策：**
```
action: buy
position_size: 0.1 (10%总资产)
```

**风控计算：**
```
1. 钱包50%限制: $50 × 50% = $25
2. AI建议: $1,000 × 10% = $100
3. 取较小值: min($25, $100) = $25
4. 检查: $25 ≥ $10 ✅
```

**结果：**
```
✅ 使用$25买入（受钱包限制）
✅ 剩余现金$25
⚠️ 建议: 平仓部分持仓释放资金
```

### 案例4：交易金额过小

**账户状态：**
```
总资产: $100
现金余额: $15
```

**AI决策：**
```
action: buy
position_size: 0.05 (5%总资产)
```

**风控计算：**
```
1. 钱包50%限制: $15 × 50% = $7.5
2. AI建议: $100 × 5% = $5
3. 取较小值: $5
4. 检查: $5 < $10 ❌
```

**结果：**
```
❌ 跳过交易（金额过小）
📊 日志: "交易金额过小：$5.00 < $10.00"
```

---

## ⚙️ 配置参数

### 在 `.env` 或 `backend/config.py` 中配置

```env
# 基础风控
INITIAL_BALANCE=1000.0              # 初始余额
MAX_POSITION_SIZE=0.1               # AI最大建议仓位10%
RISK_PER_TRADE=0.02                 # 每笔风险2%

# 新增：防爆仓风控
MAX_WALLET_USAGE=0.5                # 单笔最多用50%钱包
MARGIN_RESERVE_RATIO=0.3            # 合约只用30%，留70%保证金

# 高级风控
RISK_THRESHOLD=0.7                  # 风险评分>0.7拒绝
CONFIDENCE_THRESHOLD=0.6            # 置信度<0.6不执行
```

### 参数调整建议

**保守策略：**
```env
MAX_WALLET_USAGE=0.3                # 30%
MARGIN_RESERVE_RATIO=0.2            # 20%使用，80%保证金
MAX_POSITION_SIZE=0.05              # 5%
```

**激进策略：**
```env
MAX_WALLET_USAGE=0.7                # 70%
MARGIN_RESERVE_RATIO=0.5            # 50%使用，50%保证金
MAX_POSITION_SIZE=0.15              # 15%
```

**当前配置（平衡）：**
```env
MAX_WALLET_USAGE=0.5                # 50% ✅
MARGIN_RESERVE_RATIO=0.3            # 30% ✅
MAX_POSITION_SIZE=0.1               # 10% ✅
```

---

## 📈 风控效果示例

### 场景：做空BTC防爆仓

**初始状态：**
```
现金余额: $600
BTC价格: $100,000
```

**旧逻辑（无保证金保护）：**
```
❌ 可能用$300做空（50%余额）
❌ 保证金: $300
❌ BTC涨100%到$200,000: 爆仓！
```

**新逻辑（有保证金保护）：**
```
✅ 只用$180做空（30%余额）
✅ 保证金: $420（70%预留）
✅ BTC涨233%到$333,000: 才会爆仓
✅ 安全性提升2.3倍！
```

---

## 🔍 日志示例

### 现货交易日志

```
💰 风控计算详情:
   现金余额: $600.00
   持仓价值: $400.00
   AI建议使用: $100.00 (10.0%总资产)
   钱包限制(50%): $300.00
   实际使用: $100.00
   交易数量: 0.000917 BTCUSDT
✅ 交易执行成功: BTCUSDT buy 0.000917 @ $109,000.00
```

### 合约交易日志

```
💰 风控计算详情:
   现金余额: $600.00
   持仓价值: $400.00
   AI建议使用: $200.00 (20.0%总资产)
   钱包限制(50%): $300.00
   实际使用: $180.00
   交易数量: 0.001651 BTCUSDT
🛡️ 合约交易保证金保护：使用30%余额，预留$420.00保证金防止爆仓
✅ 交易执行成功: BTCUSDT short 0.001651 @ $109,000.00
```

### 余额不足日志

```
💰 风控计算详情:
   现金余额: $50.00
   AI建议使用: $100.00 (10.0%总资产)
   钱包限制(50%): $25.00
   实际使用: $25.00
⚠️ 交易金额过小：$25.00 < $10.00，跳过交易
```

---

## 📊 风控规则对比

### 修改前 vs 修改后

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| **单笔限制** | 仅AI建议 | AI建议 且 ≤50%钱包 |
| **合约保证金** | ❌ 无保护 | ✅ 预留70%保证金 |
| **最小金额** | ❌ 无限制 | ✅ 至少$10 |
| **余额检查** | ✅ 有 | ✅ 强化 |
| **爆仓风险** | ⚠️ 中等 | ✅ 极低 |
| **日志详情** | 简单 | ✅ 详细 |

### 安全性提升

**现货交易：**
```
修改前: 可能用90%余额
修改后: 最多50%余额
安全性: 提升1.8倍
```

**合约交易：**
```
修改前: 可能用50%余额，保证金不足
修改后: 只用30%余额，70%作为保证金
安全性: 提升2.3倍
爆仓距离: 从100%涨幅 → 233%涨幅
```

---

## 🎯 实际运行效果

### 测试场景

**初始：**
```
总资产: $1,000
现金: $1,000
持仓: $0
```

**第1笔买入BTC：**
```
AI建议: 10%总资产 = $100
钱包限制: $1,000 × 50% = $500
实际使用: $100 ✅
剩余现金: $900
```

**第2笔做空ETH：**
```
AI建议: 15%总资产 = $150
钱包限制: $900 × 50% = $450
合约限制: $900 × 30% = $270
实际使用: $150 ✅
预留保证金: $750
剩余现金: $750
```

**第3笔买入BNB：**
```
AI建议: 10%总资产 = $100
钱包限制: $750 × 50% = $375
实际使用: $100 ✅
剩余现金: $650
```

**持仓分布：**
```
BTC: $100
ETH空仓: $150（预留保证金$750）
BNB: $100
剩余现金: $650
总资产: $1,000
资金利用率: 35%（安全）
```

---

## 🔧 如何调整风控参数

### 更保守（推荐初学者）

```env
MAX_WALLET_USAGE=0.3                # 单笔最多30%
MARGIN_RESERVE_RATIO=0.2            # 合约只用20%
MAX_POSITION_SIZE=0.05              # AI最大建议5%
RISK_THRESHOLD=0.6                  # 风险阈值降低
```

**效果：**
- ✅ 单笔交易更小
- ✅ 保证金更充足
- ✅ 爆仓风险极低
- ⚠️ 盈利速度较慢

### 平衡策略（当前默认）

```env
MAX_WALLET_USAGE=0.5                # 单笔最多50% ✅
MARGIN_RESERVE_RATIO=0.3            # 合约用30% ✅
MAX_POSITION_SIZE=0.1               # AI最大建议10% ✅
RISK_THRESHOLD=0.7                  # 标准风险阈值 ✅
```

**效果：**
- ✅ 风险与收益平衡
- ✅ 合理的资金利用率
- ✅ 足够的安全缓冲
- ✅ 适合大多数情况

### 激进策略（不推荐新手）

```env
MAX_WALLET_USAGE=0.7                # 单笔最多70%
MARGIN_RESERVE_RATIO=0.5            # 合约用50%
MAX_POSITION_SIZE=0.2               # AI最大建议20%
RISK_THRESHOLD=0.8                  # 风险阈值提高
```

**效果：**
- ⚠️ 资金利用率高
- ⚠️ 潜在收益高
- ⚠️ 风险也更高
- ❌ 爆仓风险增加

---

## 📝 风控规则代码位置

**实现位置：** `backend/trading/trading_engine.py`

**关键代码段（第213-267行）：**
```python
async def _execute_trade(self, db, symbol, team_decision, market_data):
    # 获取现金余额
    positions = await self._get_current_positions(db)
    positions_value = sum(p['amount'] * p['current_price'] for p in positions)
    cash_balance = self.current_balance - positions_value
    
    # 规则1: 钱包50%限制
    max_trade_by_wallet = cash_balance * settings.max_wallet_usage
    
    # 规则2: AI建议
    ai_suggested_value = self.current_balance * position_size
    
    # 规则3: 合约保证金
    if action == "short":
        margin_ratio = settings.margin_reserve_ratio
        max_trade_value = min(max_trade_value, cash_balance * margin_ratio)
        logger.info(f"🛡️ 预留${reserved_margin:.2f}保证金防止爆仓")
    
    # 规则4: 最小金额
    if max_trade_value < 10.0:
        logger.warning("交易金额过小，跳过")
        return
```

---

## 🎉 总结

### 新增的风控保护

✅ **钱包余额保护** - 单笔最多50%  
✅ **合约保证金保护** - 预留70%防爆仓  
✅ **最小金额保护** - 避免微小交易  
✅ **详细日志** - 完整的风控计算过程  

### 安全性提升

```
修改前: 可能全仓梭哈，爆仓风险高
修改后: 
  ✅ 现货最多50%余额
  ✅ 合约最多30%余额，70%保证金
  ✅ 爆仓风险降低2-3倍
  ✅ 本金安全性极大提升
```

### 当前配置

```
✅ 钱包使用上限: 50%
✅ 合约保证金预留: 70%
✅ AI仓位建议: 10%
✅ 最小交易: $10
✅ 风险阈值: 0.7
```

**系统现在具有专业级的风控保护！** 🛡️

---

**更新时间：** 2025年10月23日 22:15  
**版本：** v4.1 - 增强风控版  
**状态：** ✅ 风控规则已实施，防爆仓保护启用

