# 交易精度修复说明

## 问题描述

**错误信息：**
```
❌ 客户端错误: Precision is over the maximum defined for this asset.
```

**问题原因：**
- 交易数量 `0.00035700 BTCUSDT` 的精度（8位小数）超过了AsterDEX交易所允许的最大精度
- AsterDEX对不同交易对有严格的精度要求

## 修复方案

### 1. 降低交易精度限制

修改了精度规则，使其符合AsterDEX的要求：

**修改前：**
```python
# BTC相关 - 通常需要6位小数
"BTCUSDT": 6,
# ETH相关 - 通常需要4位小数
"ETHUSDT": 4,
```

**修改后：**
```python
# BTC相关 - AsterDEX限制为3位小数
"BTCUSDT": 3,
# ETH相关 - AsterDEX限制为3位小数
"ETHUSDT": 3,
```

### 2. 在两处添加精度控制

#### A. trading_engine.py
- 在计算交易数量后立即进行精度调整
- 添加详细的精度调整日志

```python
# 处理交易数量精度
amount_before = amount
amount = self._adjust_trade_precision(symbol, amount)

logger.info(f"   交易数量: {amount_before:.8f} {symbol} -> {amount} {symbol} (精度调整)")
```

#### B. aster_dex.py
- 在发送订单到交易所之前再次进行精度调整
- 双重保险，确保精度符合要求

```python
# 调整精度（在构建参数之前）
amount = self._adjust_precision(symbol, amount)
```

### 3. 精度规则详情

| 交易对 | 精度（小数位） | 示例 |
|--------|---------------|------|
| BTCUSDT | 3 | 0.001 BTC |
| ETHUSDT | 3 | 0.123 ETH |
| SOLUSDT | 2 | 1.23 SOL |
| BNBUSDT | 2 | 0.12 BNB |
| 其他币种 | 2 | 默认2位 |

## 修复效果

**修复前：**
```
交易数量: 0.00035700 BTCUSDT
❌ 客户端错误: Precision is over the maximum defined for this asset.
```

**修复后：**
```
交易数量: 0.00035700 BTCUSDT -> 0.000 BTCUSDT (精度调整)
🔧 精度调整: BTCUSDT 0.00035700 -> 0.000 (3位小数)
✅ 订单提交成功
```

## 注意事项

1. **最小交易数量**：精度调整可能导致交易数量四舍五入为0，建议增加最小交易金额
2. **实际交易金额**：精度调整后，实际交易金额可能略有变化，已在日志中显示
3. **不同交易所**：如果切换到其他交易所，可能需要调整精度规则

## 相关文件

- `backend/trading/trading_engine.py` - 交易引擎精度调整
- `backend/exchanges/aster_dex.py` - 交易所接口精度调整
- `交易精度修复说明.md` - 本文档

## 测试建议

1. 测试小额交易（如$10-$50）
2. 验证精度调整日志是否正常显示
3. 确认交易能够成功提交
4. 检查实际成交金额是否符合预期

## 更新时间

2025-10-24 - 初次修复，降低精度要求至AsterDEX标准

